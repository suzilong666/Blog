# 事件循环

## 核心概念

JavaScript 是单线程的，这意味着它一次只能执行一个任务。事件循环（Event Loop）是 JavaScript 处理异步操作的机制，使得非阻塞 I/O 成为可能。

## 事件循环的组成

### 调用栈（Call Stack）

- 后进先出（LIFO）的数据结构
- 存储函数的执行上下文
- 同步任务按顺序执行

### 任务队列（Task Queue）

- 先进先出（FIFO）的数据结构
- 存储异步任务的回调函数
- 分为宏任务队列和微任务队列

### Web APIs / C++ APIs

- 浏览器提供的异步 API
- Node.js 的 C++ 扩展

例如：setTimeout、DOM 事件、AJAX、文件读写

## 宏任务（Macrotasks）

- setTimeout、setInterval
- setImmediate（Node.js）
- I/O 操作
- UI 渲染（浏览器）
- requestAnimationFrame（浏览器）
- script（整体代码）

## 微任务（Microtasks）

- Promise.then()、Promise.catch()、Promise.finally()
- async/await
- MutationObserver（浏览器）
- process.nextTick（Node.js，优先级最高）
- queueMicrotask()

## 事件循环执行顺序

1. 执行同步代码，这些代码会进入调用栈，直到栈为空。
2. 处理微任务（microtasks）：在调用栈为空后，JavaScript引擎会检查微任务队列，并依次执行微任务，直到微任务队列为空。
3. 执行渲染（如果需要）：在浏览器环境中，如果当前需要更新渲染，则会执行渲染操作。
4. 从宏任务队列中取出一个任务执行。
5. 重复步骤2到4。