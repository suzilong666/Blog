# 事件循环

## 进程和线程的基本概念

### 什么是进程

程序运行需要有它自己专属的内存空间，可以把这块内存空间简单理解为进程。

进程是操作系统进行**资源分配**和**调度**的基本单位。

### 什么是线程

线程是进程内部的一个执行路径，是**CPU调度**和**执行**的最小单位。

### 线程与进程的关键关系

- 一个进程可以包含多个线程。
- 同一个进程里的所有线程，共享该进程的资源（如内存地址空间、打开的文件、全局变量等）。这意味着线程之间可以非常方便地通信，但同时也带来了“数据混乱”的风险（需要引入锁等同步机制）。
- 线程自己只拥有一些运行时必不可少的资源，比如自己的程序计数器（记录执行到哪一行）、一组寄存器和自己的栈（用于存放局部变量）。这些是保证它能独立执行的基础。

### 进程与线程的主要区别

| 特性   | 进程                                                    | 线程                                                     |
| ------ | ------------------------------------------------------- | -------------------------------------------------------- |
| 本质   | 资源分配的基本单位                                      | CPU调度和执行的基本单位                                  |
| 资源   | 拥有独立的地址空间和系统资源                            | 共享所属进程的地址空间和资源                             |
| 通信   | 进程间通信（IPC）复杂，需要特殊机制（如管道、消息队列） | 线程间通信非常简单，可以直接读写共享数据（但需注意同步） |
| 开销   | 创建和销毁进程的开销大                                  | 创建和销毁线程的开销小                                   |
| 独立性 | 进程之间相互独立，一个进程崩溃一般不会影响其他进程      | 一个线程崩溃很可能导致其所属的整个进程崩溃               |

## 浏览器进程模型

**浏览器是一个多进程多线程的应用程序。**

浏览器内部工作及其复杂。为了避免相互影响，减少连环崩溃的几率，当启动浏览器后，它会自动启动多个进程。

其中，最主要的进程有：

1. 浏览器进程（Browser Process）
   主要负责界面显示，用户交互，子进程管理等。浏览器进程内部会启动多个线程处理不同的任务。
2. 网络进程
   负责加载网络资源。网络进程内部会启动多个线程来处理不同的网络任务。
3. **渲染进程（重要）**
   渲染进程启动后，会开启一个**渲染主线程**，主线程负责执行 HTML，CSS，JS 代码。
   默认情况下，浏览器会为每一个标签页开启一个新的渲染进程，以保证不同的标签页之间不会互相影响。

## 渲染主线程如何工作？

渲染主线程是浏览器最繁忙的线程，需要它处理的任务包括但不限于：

- 解析 HTML
- 解析 CSS
- 布局
- 处理图层
- 执行全局 JS 代码
- 执行事件处理函数
- 执行计时器回调函数
- 。。。。

> 思考：为什么渲染线程不适用多个线程来处理这些事情？

要出来这么多任务，主线程遇到了一个前所未有的难题：如何调度任务？

比如：

- 我正在执行一个 JS 函数，执行到一半的时候用户点击了按钮，我该立即去执行点击事件的处理函数吗？
- 我正在执行一个 JS 函数，执行到一半的时候某个计时器到达了时间，我该立即去执行它的回调函数吗？
- 浏览器进程通知我 “用户点击了按钮”，与此同时，某个计时器也到达了时间，我该处理哪一个？

渲染主线程想出了一个绝妙的主意来处理这个问题：**排队**

## 核心概念

JavaScript 是单线程的，这意味着它一次只能执行一个任务。事件循环（Event Loop）是 JavaScript 处理异步操作的机制，使得非阻塞 I/O 成为可能。

## 事件循环的组成

### 调用栈（Call Stack）

- 后进先出（LIFO）的数据结构
- 存储函数的执行上下文
- 同步任务按顺序执行

### 任务队列（Task Queue）

- 先进先出（FIFO）的数据结构
- 存储异步任务的回调函数
- 分为宏任务队列和微任务队列

### Web APIs / C++ APIs

- 浏览器提供的异步 API
- Node.js 的 C++ 扩展

例如：setTimeout、DOM 事件、AJAX、文件读写

## 宏任务（Macrotasks）

- setTimeout、setInterval
- setImmediate（Node.js）
- I/O 操作
- UI 渲染（浏览器）
- requestAnimationFrame（浏览器）
- script（整体代码）

## 微任务（Microtasks）

- Promise.then()、Promise.catch()、Promise.finally()
- async/await
- MutationObserver（浏览器）
- process.nextTick（Node.js，优先级最高）
- queueMicrotask()

## 事件循环执行顺序

1. 执行同步代码，这些代码会进入调用栈，直到栈为空。
2. 处理微任务（microtasks）：在调用栈为空后，JavaScript引擎会检查微任务队列，并依次执行微任务，直到微任务队列为空。
3. 执行渲染（如果需要）：在浏览器环境中，如果当前需要更新渲染，则会执行渲染操作。
4. 从宏任务队列中取出一个任务执行。
5. 重复步骤2到4。