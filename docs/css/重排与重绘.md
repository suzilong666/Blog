# 重排与重绘

## 核心概念

**重排（Reflow / Layout）：**当 DOM 元素的位置、尺寸、布局发生改变时，浏览器需要重新计算元素的几何属性，并重新构建渲染树的过程。

**重绘（Repaint）：**当元素的外观（颜色、背景、边框等）发生改变，但不影响布局时，浏览器需要重新绘制元素的过程。

## 区别

| 特性     | 重排               | 重绘               |
| -------- | ------------------ | ------------------ |
| 触发条件 | 几何属性改变       | 外观属性改变       |
| 性能消耗 | 高（涉及布局计算） | 较低（只涉及绘制） |
| 必然关系 | 重排必定引起重绘   | 重绘不一定引起重排 |

## 触发重排的操作

```js
// 1. 几何尺寸改变
element.style.width = '100px'
element.style.height = '100px'
element.style.padding = '10px'

// 2. 布局相关属性
element.style.position = 'absolute'
element.style.display = 'none'

// 3. 内容变化
element.innerHTML = '新内容'

// 4. 字体变化
element.style.fontSize = '16px'

// 5. 窗口大小改变
window.resizeBy(10, 10)

// 6. 获取计算样式（会强制同步重排）
const width = element.offsetWidth
const height = element.offsetHeight
```

## 触发重绘的操作

```js
// 只改变外观，不影响布局
element.style.color = 'red'
element.style.backgroundColor = '#fff'
element.style.outline = '1px solid blue'
element.style.visibility = 'hidden'  // 注意：与 display:none 不同
```

## 优化策略
1. 减少 DOM 操作
```js
// 不推荐：多次操作 DOM
for (let i = 0; i < 100; i++) {
    document.body.appendChild(document.createElement('div'))
}

// 推荐：使用文档碎片
const fragment = document.createDocumentFragment()
for (let i = 0; i < 100; i++) {
    fragment.appendChild(document.createElement('div'))
}
document.body.appendChild(fragment)
```

2. 批量样式修改
```js
// 不推荐：多次修改样式
element.style.width = '100px'
element.style.height = '100px'
element.style.margin = '10px'

// 推荐1：使用 class
element.className = 'new-style'

// 推荐2：使用 cssText
element.style.cssText = 'width:100px; height:100px; margin:10px;'
```

3. 使用 transform 和 opacity

```css
/* 这些属性不会触发重排，使用 GPU 加速 */
.element {
    transform: translate3d(0, 0, 0); /* 开启 GPU 加速 */
    opacity: 0.5;
    will-change: transform; /* 提前告知浏览器 */
}
```

4. 离线 DOM 操作

```js
// 先将元素隐藏或移出文档流
element.style.display = 'none'
// 执行大量 DOM 操作
// ...
element.style.display = 'block'
```

## 调试工具

1. Chrome DevTools Performance 面板
   - 记录性能时间线
   - 查看 Layout（重排）和 Paint（重绘）事件

2. 渲染面板
   - 打开 Paint flashing（查看重绘区域）
   - 打开 Layout Shift Regions（查看布局偏移）